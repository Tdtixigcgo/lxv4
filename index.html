<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ğŸ§§ LÃ¬ XÃ¬ Online â€” Táº¡o phÃ²ng lÃ¬ xÃ¬ miá»…n phÃ­</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="bg-layer"></div>
<div class="bg-pattern"></div>

<!-- LOADING -->
<div id="loading-screen">
  <div class="ld-logo">ğŸ§§</div>
  <p class="ld-title">LÃ¬ XÃ¬ Online</p>
  <p class="ld-msg">Äang táº£i...</p>
  <div class="ld-bar"><div class="ld-fill"></div></div>
</div>

<!-- HERO -->
<div class="page-wrapper" id="main-page" style="display:none">
  <div class="container" style="display:flex;flex-direction:column;align-items:center">

    <!-- HERO SECTION -->
    <section class="hero-section">
      <span class="hero-emoji">ğŸ§§</span>
      <h1 class="hero-title">LÃ¬ XÃ¬ Online</h1>
      <p class="hero-sub">Táº¡o phÃ²ng lÃ¬ xÃ¬ may máº¯n cho gia Ä‘Ã¬nh & báº¡n bÃ¨. Realtime, Ä‘áº¹p máº¯t, miá»…n phÃ­ hoÃ n toÃ n.</p>
      <div class="hero-actions">
        <button class="btn-gold" id="open-create-btn">ğŸŠ Táº¡o phÃ²ng lÃ¬ xÃ¬</button>
        <a class="btn-ghost" href="/admin">ğŸ” Admin panel</a>
      </div>

      <!-- FEATURES -->
      <div class="features-grid">
        <div class="feature-card">
          <span class="fc-icon">âš¡</span>
          <div class="fc-title">Realtime tá»©c thÃ¬</div>
          <div class="fc-desc">Má»Ÿ Ã´ lÃ  cáº­p nháº­t ngay trÃªn táº¥t cáº£ mÃ n hÃ¬nh â€” khÃ´ng cáº§n F5.</div>
        </div>
        <div class="feature-card">
          <span class="fc-icon">ğŸ”¥</span>
          <div class="fc-title">Ã” Ä‘áº·c biá»‡t bÃ­ máº­t</div>
          <div class="fc-desc">Hiá»‡n 10k nhÆ°ng thá»±c 500k. Admin kiá»ƒm soÃ¡t toÃ n bá»™ má»‡nh giÃ¡.</div>
        </div>
        <div class="feature-card">
          <span class="fc-icon">ğŸ›¡</span>
          <div class="fc-title">Admin 100% quyá»n háº¡n</div>
          <div class="fc-desc">Sá»­a tá»«ng Ã´, reset, clone phÃ²ng, xuáº¥t bÃ¡o cÃ¡o CSV, xem QR code.</div>
        </div>
        <div class="feature-card">
          <span class="fc-icon">ğŸ“±</span>
          <div class="fc-title">Má»i thiáº¿t bá»‹</div>
          <div class="fc-desc">Äáº¹p trÃªn Ä‘iá»‡n thoáº¡i, tablet, mÃ¡y tÃ­nh. Chia sáº» link lÃ  chÆ¡i ngay.</div>
        </div>
      </div>
    </section>

    <!-- ROOMS LIST -->
    <section class="rooms-section" id="rooms-section" style="display:none">
      <div style="display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:4px;flex-wrap:wrap;gap:12px">
        <div>
          <h2 class="section-heading">PhÃ²ng Ä‘ang hoáº¡t Ä‘á»™ng</h2>
          <p class="section-desc">CÃ¡c phÃ²ng lÃ¬ xÃ¬ gáº§n Ä‘Ã¢y â€” click Ä‘á»ƒ vÃ o bá»‘c</p>
        </div>
        <button class="btn-gold" id="open-create-btn2" style="padding:12px 24px;font-size:.85rem">+ Táº¡o phÃ²ng má»›i</button>
      </div>
      <div class="rooms-grid" id="rooms-grid">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>
    </section>

    <footer class="site-footer" style="width:100%;text-align:center;margin-top:20px">
      <p style="font-size:.7rem;color:rgba(245,200,66,.18);letter-spacing:4px;font-family:'DM Mono',monospace">âœ¦ LÃ¬ XÃ¬ Platform v4 Â· Made with â¤ï¸ âœ¦</p>
    </footer>
  </div>
</div>

<!-- CREATE ROOM MODAL -->
<div id="create-modal">
  <div class="create-card">
    <div class="create-header">
      <span class="create-header-title">ğŸŠ Táº¡o phÃ²ng lÃ¬ xÃ¬ má»›i</span>
      <button class="create-close" id="create-close-btn">âœ•</button>
    </div>
    <div class="create-body">

      <!-- STEP 1: ThÃ´ng tin phÃ²ng -->
      <div class="create-step">
        <div class="create-step-title">ThÃ´ng tin phÃ²ng</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">TÃªn phÃ²ng lÃ¬ xÃ¬</label>
            <input class="form-input" id="cr-title" type="text" placeholder="LÃ¬ XÃ¬ Táº¿t 2025" maxlength="60"/>
          </div>
          <div class="form-group">
            <label class="form-label">Phá»¥ Ä‘á»</label>
            <input class="form-input" id="cr-subtitle" type="text" placeholder="ChÃºc má»«ng nÄƒm má»›i ğŸŒ¸" maxlength="80"/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">TÃªn chá»§ phÃ²ng (tÃ¹y chá»n)</label>
            <input class="form-input" id="cr-host" type="text" placeholder="Há» tÃªn cá»§a báº¡n" maxlength="40"/>
          </div>
          <div class="form-group">
            <label class="form-label">Emoji phÃ²ng</label>
            <input class="form-input" id="cr-emoji" type="text" placeholder="ğŸ§§" maxlength="4" style="font-size:1.4rem"/>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Máº­t kháº©u admin</label>
          <input class="form-input" id="cr-pass" type="password" placeholder="Äáº·t máº­t kháº©u Ä‘á»ƒ quáº£n lÃ½ phÃ²ng"/>
        </div>
      </div>

      <!-- STEP 2: Cáº¥u hÃ¬nh má»‡nh giÃ¡ -->
      <div class="create-step">
        <div class="create-step-title">Cáº¥u hÃ¬nh phong bÃ¬</div>
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label">Tá»•ng sá»‘ Ã´</label>
            <input class="form-input" id="cr-total" type="number" value="20" min="5" max="200"/>
          </div>
          <div class="form-group">
            <label class="form-label">Sá»‘ Ã´ Ä‘áº·c biá»‡t</label>
            <input class="form-input" id="cr-specials" type="number" value="2" min="0" max="10" id="cr-specials"/>
          </div>
          <div class="form-group">
            <label class="form-label">Confetti (0 = táº¯t)</label>
            <input class="form-input" id="cr-confetti" type="number" value="80" min="0" max="300"/>
          </div>
        </div>

        <label class="form-label" style="margin-bottom:8px">PhÃ¢n phá»‘i má»‡nh giÃ¡ (sá»‘ lÆ°á»£ng má»—i loáº¡i)</label>
        <div class="value-config-grid" id="cr-dist-grid">
          <div class="value-item"><span class="value-item-label">1k</span><input class="value-item-input" type="number" id="cd-1" value="2" min="0" max="50"/></div>
          <div class="value-item"><span class="value-item-label">2k</span><input class="value-item-input" type="number" id="cd-2" value="2" min="0" max="50"/></div>
          <div class="value-item"><span class="value-item-label">3k</span><input class="value-item-input" type="number" id="cd-3" value="2" min="0" max="50"/></div>
          <div class="value-item"><span class="value-item-label">5k</span><input class="value-item-input" type="number" id="cd-5" value="3" min="0" max="50"/></div>
          <div class="value-item"><span class="value-item-label">10k</span><input class="value-item-input" type="number" id="cd-10" value="4" min="0" max="50"/></div>
          <div class="value-item"><span class="value-item-label">15k</span><input class="value-item-input" type="number" id="cd-15" value="2" min="0" max="50"/></div>
          <div class="value-item"><span class="value-item-label">20k</span><input class="value-item-input" type="number" id="cd-20" value="3" min="0" max="50"/></div>
          <div class="value-item"><span class="value-item-label">50k</span><input class="value-item-input" type="number" id="cd-50" value="0" min="0" max="50"/></div>
          <div class="value-item"><span class="value-item-label">100k</span><input class="value-item-input" type="number" id="cd-100" value="0" min="0" max="50"/></div>
        </div>

        <label class="form-label" style="margin-top:14px;margin-bottom:8px">Má»‡nh giÃ¡ thá»±c Ã´ Ä‘áº·c biá»‡t (k)</label>
        <div id="cr-special-inputs" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="form-group"><label class="form-label">Giáº£i Ä‘áº·c biá»‡t 1</label><input class="form-input" id="csv-0" type="number" value="200" min="1"/></div>
          <div class="form-group"><label class="form-label">Giáº£i Ä‘áº·c biá»‡t 2</label><input class="form-input" id="csv-1" type="number" value="500" min="1"/></div>
        </div>
      </div>

      <p class="cr-err" id="cr-err" style="color:rgba(255,100,100,.75);font-size:.8rem;min-height:18px;margin-bottom:10px"></p>
      <button class="create-submit" id="cr-submit-btn">ğŸ² Táº¡o phÃ²ng lÃ¬ xÃ¬ ngay!</button>

      <!-- SUCCESS -->
      <div class="success-box" id="cr-success" style="display:none">
        <p class="success-title">âœ… Táº¡o phÃ²ng thÃ nh cÃ´ng!</p>
        <div class="link-row">
          <div class="link-label">ğŸŠ Link phÃ²ng chÆ¡i (chia sáº» cho má»i ngÆ°á»i)</div>
          <div class="link-box">
            <span class="link-text" id="cr-room-link">â€”</span>
            <button class="copy-btn" onclick="copyText('cr-room-link')">Copy</button>
          </div>
        </div>
        <div class="link-row">
          <div class="link-label">ğŸ” Link admin (giá»¯ bÃ­ máº­t)</div>
          <div class="link-box">
            <span class="link-text" id="cr-admin-link">â€”</span>
            <button class="copy-btn" onclick="copyText('cr-admin-link')">Copy</button>
          </div>
        </div>
        <p class="hint-note">âš  LÆ°u link admin láº¡i ngay! Báº¡n sáº½ cáº§n nÃ³ Ä‘á»ƒ quáº£n lÃ½ phÃ²ng.</p>
        <div class="success-actions">
          <a class="btn-gold" id="cr-go-room" href="#" style="padding:12px 22px;font-size:.88rem">ğŸŠ VÃ o phÃ²ng ngay</a>
          <a class="btn-ghost" id="cr-go-admin" href="#" style="padding:12px 22px;font-size:.88rem">âš™ï¸ Admin panel</a>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="config.js"></script>
<script>
'use strict';
let sb;
const $ = id => document.getElementById(id);

function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}

// â”€â”€ BOOT â”€â”€
document.addEventListener('DOMContentLoaded', async () => {
  sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  await loadRooms();
  hideLoading();

  $('open-create-btn').onclick  = () => openCreate();
  $('open-create-btn2').onclick = () => openCreate();
  $('create-close-btn').onclick = () => closeCreate();
  $('cr-submit-btn').onclick    = () => createRoom();

  $('cr-specials').addEventListener('input', () => buildSpecialInputs());
  document.getElementById('create-modal').addEventListener('click', e => {
    if(e.target.id==='create-modal') closeCreate();
  });
});

function hideLoading(){
  const el=$('loading-screen');
  el.classList.add('hidden');
  setTimeout(()=>{el.style.display='none'; $('main-page').style.display='flex';},600);
}

// â”€â”€ LOAD ROOMS â”€â”€
async function loadRooms(){
  const {data} = await sb.from('rooms')
    .select('id,title,host_name,emoji,is_open,envelope_count,opened_count,created_at')
    .order('created_at',{ascending:false}).limit(30);
  if(!data||!data.length) return;
  $('rooms-section').style.display='block';
  renderRooms(data);
}

function renderRooms(rooms){
  const g=$('rooms-grid');
  if(!rooms.length){
    g.innerHTML='<div class="empty-state"><span class="empty-state-icon">ğŸ§§</span><p>ChÆ°a cÃ³ phÃ²ng nÃ o. HÃ£y táº¡o phÃ²ng Ä‘áº§u tiÃªn!</p></div>';
    return;
  }
  g.innerHTML=rooms.map(r=>`
    <a class="room-card" href="/room/${r.id}">
      <div class="rc-top">
        <span class="rc-emoji">${r.emoji||'ğŸ§§'}</span>
        <span class="rc-badge ${r.is_open?'open':'closed'}">${r.is_open?'ğŸŸ¢ Má»':'ğŸ”´ ÄÃ“NG'}</span>
      </div>
      <div class="rc-title">${escHtml(r.title||'PhÃ²ng LÃ¬ XÃ¬')}</div>
      <div class="rc-host">${r.host_name?'ğŸ‘¤ '+escHtml(r.host_name):''}</div>
      <div class="rc-stats">
        <span class="rc-stat">ğŸ§§ ${r.envelope_count||0} Ã´</span>
        <span class="rc-stat">âœ… ${r.opened_count||0} Ä‘Ã£ má»Ÿ</span>
        <span class="rc-stat">ğŸ“… ${new Date(r.created_at).toLocaleDateString('vi-VN')}</span>
      </div>
    </a>`).join('');
}

// â”€â”€ CREATE MODAL â”€â”€
function openCreate(){
  $('create-modal').classList.add('show');
  $('cr-success').style.display='none';
  $('cr-err').textContent='';
  $('cr-submit-btn').style.display='block';
  buildSpecialInputs();
  setTimeout(()=>$('cr-title').focus(),200);
}
function closeCreate(){ $('create-modal').classList.remove('show'); }

function buildSpecialInputs(){
  const n=parseInt($('cr-specials').value)||0;
  const c=$('cr-special-inputs');
  c.innerHTML=Array.from({length:Math.min(n,10)},(_,i)=>
    `<div class="form-group"><label class="form-label">Giáº£i Ä‘áº·c biá»‡t ${i+1} (k)</label><input class="form-input" id="csv-${i}" type="number" value="${(i+1)*200}" min="1"/></div>`
  ).join('');
  c.style.gridTemplateColumns = n<=2 ? '1fr 1fr' : 'repeat(auto-fill,minmax(130px,1fr))';
}

function copyText(id){
  const el=$(id); if(!el) return;
  navigator.clipboard.writeText(el.textContent||el.value);
  el.style.color='var(--green)';
  setTimeout(()=>el.style.color='',1500);
}

// â”€â”€ CREATE ROOM â”€â”€
async function createRoom(){
  const btn=$('cr-submit-btn');
  const title=($('cr-title').value.trim())||'LÃ¬ XÃ¬ Táº¿t 2025';
  const subtitle=$('cr-subtitle').value.trim();
  const host=$('cr-host').value.trim();
  const emoji=$('cr-emoji').value.trim()||'ğŸ§§';
  const pass=$('cr-pass').value;
  const total=parseInt($('cr-total').value)||20;
  const nSpec=parseInt($('cr-specials').value)||0;
  const confetti=parseInt($('cr-confetti').value)||80;

  if(!pass||pass.length<4){$('cr-err').textContent='âš  Máº­t kháº©u pháº£i Ã­t nháº¥t 4 kÃ½ tá»±';return;}

  btn.disabled=true; btn.textContent='â³ Äang táº¡o phÃ²ng...';
  $('cr-err').textContent='';

  // Build distribution
  const dist={};
  [1,2,3,5,10,15,20,50,100].forEach(v=>{
    const n=parseInt($(`cd-${v}`)?.value)||0;
    if(n>0) dist[v]=n;
  });
  const specialValues=Array.from({length:nSpec},(_,i)=>parseInt($(`csv-${i}`)?.value)||(i+1)*200);

  // Generate room ID
  const roomId=Math.random().toString(36).substring(2,10).toUpperCase();
  const passHash=btoa(unescape(encodeURIComponent(pass+':lixi_salt_2025')));

  // Insert room
  const{error:re}=await sb.from('rooms').insert({
    id:roomId, title, subtitle, host_name:host||null, emoji,
    pass_hash:passHash, is_open:true, envelope_count:total, opened_count:0,
    config:{distribution:dist,totalEnvelopes:total,specialValues,confettiCount:confetti,showPlayerCount:true,showValue:true,onePerPerson:true}
  });
  if(re){$('cr-err').textContent='âŒ '+re.message;btn.disabled=false;btn.textContent='ğŸ² Táº¡o phÃ²ng lÃ¬ xÃ¬ ngay!';return;}

  // Generate envelopes
  let pool=[];
  Object.entries(dist).forEach(([v,c])=>{for(let i=0;i<c;i++) pool.push(parseInt(v));});
  while(pool.length<total-specialValues.length) pool.push(10);
  pool=shuffle(pool).slice(0,total-specialValues.length);

  const svShuffled=shuffle([...specialValues]);
  const allPos=shuffle(Array.from({length:total},(_,i)=>i));
  const spPos=new Set(allPos.slice(0,specialValues.length));

  const rows=[];
  let ni=0,si=0;
  for(let i=0;i<total;i++){
    if(spPos.has(i)){
      const displayVals=Object.keys(dist).map(Number).filter(v=>v<=20);
      const display=displayVals[Math.floor(Math.random()*displayVals.length)]||10;
      rows.push({room_id:roomId,position:i,display_value:display,real_value:svShuffled[si%svShuffled.length],is_special:true,opened:false});
      si++;
    }else{
      rows.push({room_id:roomId,position:i,display_value:pool[ni%pool.length]||10,real_value:pool[ni%pool.length]||10,is_special:false,opened:false});
      ni++;
    }
  }

  const{error:ee}=await sb.from('envelopes').insert(rows);
  if(ee){$('cr-err').textContent='âŒ '+ee.message;btn.disabled=false;btn.textContent='ğŸ² Táº¡o phÃ²ng lÃ¬ xÃ¬ ngay!';return;}

  // Show success
  btn.style.display='none';
  const base=location.origin;
  $('cr-room-link').textContent=`${base}/room/${roomId}`;
  $('cr-admin-link').textContent=`${base}/admin/${roomId}`;
  $('cr-go-room').href=`${base}/room/${roomId}`;
  $('cr-go-admin').href=`${base}/admin/${roomId}`;
  $('cr-success').style.display='block';

  // Reload rooms list
  loadRooms();
}
</script>
</body>
</html>
